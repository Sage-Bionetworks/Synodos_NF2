---
output:
  pdf_document: default
  html_document: default
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
library(data.table)
library(plyr)
library(dplyr)
library(synapseClient)
library(ggplot2)
library(tibble)
library(parallel)
library(Rtsne.multicore)

synapseLogin("allawayr", "***REMOVED***")

exp <-fread(synGet("syn9706056")@filePath, sep = "\t", header = TRUE)
exp$gene_id <- exp$V1
exp <- select(exp, -V1)

rsem <- tibble::tribble(
         ~synid,          ~sample,
   "syn5269690",       "MIN31981",
   "syn5269698",         "MN408a",
   "syn5269706",         "MN408b",
   "syn5269714",         "MN408c",
   "syn5269722",    "MN460_MN556",
   "syn5269731",          "MN466",
   "syn5269739",          "MN479",
   "syn5269747",          "MN491",
   "syn5269755",          "MN492",
   "syn5269762",          "MN505",
   "syn5269771",          "MN506",
   "syn5269779",          "MN514",
   "syn5269787",          "MN516",
   "syn5269795",          "MN520",
   "syn5269803",          "MN521",
   "syn5269810",          "MN527",
   "syn5269819",          "MN529",
   "syn5269827",          "MN533",
   "syn5269835",          "MN548",
   "syn5269843",          "MN560",
   "syn5269850",          "MN563",
   "syn5269858",          "MN567",
   "syn5269866",          "MN571",
   "syn5269874",          "MN572",
   "syn5269881",  "NFT_735_MN522",
   "syn5269889",  "xT_6491_MN474",
   "syn5567261",        "MN491-1",
   "syn5567265",        "MN491-2",
   "syn5567269",        "MN527-1",
   "syn5567273",        "MN527-2",
   "syn5567277",        "MN571-1",
   "syn5567281",        "MN571-2"
  )

```


```{r, message=FALSE, warning=FALSE, include=FALSE}
synodos<-lapply(rsem$synid, function(i){
  x <- synGet(i)
  y <- read.table(x@filePath, header = TRUE)
  z <- y %>% select(gene_id, TPM)
  colnames(z) <- c("gene_id", sub(".txt.genes", "", x@annotations@annotations@stringAnnotations$specimenID))
  return(z)
  })

synodos.all <- synodos %>% Reduce(function(dtf1,dtf2)
  full_join(dtf1,dtf2,by="gene_id"), .)
colnames(synodos.all) <- gsub("\\-", "\\.", colnames(synodos.all))

all <- inner_join(synodos.all, exp)
rownames(all) <- all$gene_id
all <- select(all, -gene_id)
```


```{r, message=FALSE, warning=FALSE, include=FALSE}
##get colors
tss <- read.table(synGet("syn9716995")@filePath, header = TRUE, sep = "\t", comment.char = "", quote = "")
abr <- read.table(synGet("syn9717178")@filePath, header = TRUE, sep = "\t", comment.char = "", quote = "")
abr <- full_join(tss, abr)
samples <- distinct(as.data.frame(colnames(all)))
samples$TSS.Code <- substring(samples$`colnames(all)`, 6, 7)
samples <- full_join(samples, abr)
samples <- select(samples, `colnames(all)`, Study.Abbreviation)
colnames(samples) <- c("sample", "cancer")

##thanks jaeddy for the colors
tcga_colors <- tribble(
    ~Color, ~cancer,
    "#ED2891", "BRCA",
    "#B2509E", "GBM",
    "#D49DC7", "LGG",
    "#C1A72F", "ACC",
    "#E8C51D", "PCPG",
    "#F9ED32", "THCA",
    "#104A7F", "CHOL",
    "#9EDDF9", "COAD",
    "#007EB5", "ESCA",
    "#CACCDB", "LIHC",
    "#6E7BA2", "PAAD",
    "#DAF1FC", "READ",
    "#00AEEF", "STAD",
    "#F6B667", "CESC",
    "#D97D25", "OV",
    "#FBE3C7", "UCEC",
    "#F89420", "UCS",
    "#97D1A9", "HNSC",
    "#009444", "UVM",
    "#754C29", "LAML",
    "#CEAC8F", "THYM",
    "#3953A4", "DLBC",
    "#BBD642", "SKCM",
    "#00A99D", "SARC",
    "#D3C3E0", "LUAD",
    "#A084BD", "LUSC",
    "#542C88", "MESO",
    "#FAD2D9", "BLCA",
    "#ED1C24", "KICH",
    "#F8AFB3", "KIRC",
    "#EA7075", "KIRP",
    "#7E1918", "PRAD",
    "#BE1E2D", "TGCT"
)

tcga_colors <- inner_join(samples, tcga_colors) %>% filter(!is.na(sample))
colorBy <- tcga_colors 
names <- colorBy$sample
colorBy <- select(colorBy, Color)
colorBy <- colorBy$Color
names(colorBy) <- names
```
##t-SNE colored by cancer
```{r, echo=FALSE, message=FALSE, warning=FALSE}
all.t <- t(all)
set.seed(30)
tsne_out <- Rtsne.multicore(all.t)


df <- as.data.frame(tsne_out$Y)
df$sample <- rownames(all.t)
df <- left_join(df, tcga_colors)
df$cancer[1:32] <- "Synodos"
df$Color[1:32] <- "#000000"
colors <- distinct(select(df, cancer, Color))
colors2 <- colors$Color
names(colors2) <- colors$cancer

p <- ggplot(data=df, aes(x=V1,y=V2, color = cancer)) + 
     geom_point() + 
     scale_color_manual(values=colors2) 

plot(p)
```
##t-SNE synodos black
```{r, echo=FALSE, message=FALSE, warning=FALSE}

colors3<-colors
colors3$Color[colors3$cancer!="Synodos"] <- "#000000"
colors3$Color[colors3$cancer!="Synodos"] <- "#BBD642"
colors4 <- colors3$Color
names(colors4) <- colors3$cancer

p <- ggplot(data=df, aes(x=V1,y=V2, color = cancer)) + 
     geom_point() + 
     scale_color_manual(values=colors4) +
     geom_point(data = subset(df, cancer = "Synodos")) 

plot(p)
```
##t-SNE synodos only
```{r, echo=FALSE, message=FALSE, warning=FALSE}
p <- ggplot(data=df %>% filter(cancer == "Synodos"), aes(x=V1,y=V2, color = cancer)) + 
     geom_point() +
     scale_color_manual(values=colors4)

plot(p)
```

